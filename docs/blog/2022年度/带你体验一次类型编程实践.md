# å¸¦ä½ ä½“éªŒä¸€æ¬¡ç±»å‹ç¼–ç¨‹å®è·µ

:::tip
>ğŸ„Hi~ å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°é‘«åŒå­¦ï¼Œèµ„æ·± IT ä»ä¸šè€…ï¼ŒInfoQ çš„ç­¾çº¦ä½œè€…ï¼Œæ“…é•¿å‰ç«¯å¼€å‘å¹¶åœ¨è¿™ä¸€é¢†åŸŸæœ‰å¤šå¹´çš„ç»éªŒï¼Œè‡´åŠ›äºåˆ†äº«æˆ‘åœ¨æŠ€æœ¯æ–¹é¢çš„è§è§£å’Œå¿ƒå¾—
:::

åœ¨çœ‹ **uniapp** çš„æ•™ç¨‹æ—¶çœ‹åˆ°å¤§é‡çš„ **API** è¿˜æ˜¯ä½¿ç”¨çš„ **callback** çš„æ–¹å¼æ¥æ¥æ”¶ **API** çš„æ‰§è¡Œç»“æœï¼Œå¤§é‡çš„ **API** åµŒå¥—ä½¿ç”¨åˆä¼šé€ æˆå›è°ƒåœ°ç‹±çš„ç°è±¡å‡ºç°ï¼Œåœ¨ [API Promise åŒ–](https://uniapp.dcloud.net.cn/api/#api-promise-%E5%8C%96) è¿™ä¸€ç¯‡ä¸­æåˆ°äº†æœ‰éƒ¨åˆ†APIæ˜¯å·²ç»åšäº† **Promise** åŒ–ï¼Œæˆ‘è¿™è¾¹ç”¨ cli å‘½ä»¤åˆå§‹åŒ–çš„ vite+ts çš„é¡¹ç›®å‘ç°æ²¡åŠæ³•ä½¿ç”¨å¯¹åº”çš„ **Promise** åŒ– APIï¼Œæ‰€ä»¥è¿˜æ˜¯é€šè¿‡ä¸€ä¸ªå·¥å…·ç±»æ¥å®ç°ä¸€ä¸‹ï¼Œé¡ºä¾¿è¯•ç€å†å†™ä¸€å†™ TypeScript ç±»å‹ç¼–ç¨‹ä»£ç ã€‚

## å·¥å…·ç±»ç¼–å†™å‡†å¤‡ï¼š

ä¸‹é¢è¿™å—ä»£ç æˆ‘ç›¸ä¿¡ä½ æœ‰è¿‡ç±»ä¼¼æƒ³æ³•çš„`jym`åº”è¯¥åœ¨ç½‘ä¸Šçœ‹åˆ°è¿‡ï¼Œé€šè¿‡å®šä¹‰è¿™æ ·ä¸€ä¸ªé«˜é˜¶å‡½æ•°æ¥å°†`uniapp api`è¿›è¡ŒåŒ…è£…ï¼Œå¹¶åœ¨æ‰§è¡Œè¿™ä¸ªé«˜é˜¶å‡½æ•°è¿”å›çš„å‡½æ•°æ—¶ä½¿ç”¨`Promise`æ¥æ¥ç®¡`api`æˆåŠŸå¤±è´¥æ‰€å¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚

```JavaScript
export const promisify = (api) => {
	return (options, ...params) => {
		return new Promise((resolve, reject) => {
			api(Object.assign({}, options, {
				success: resolve,
				fail: reject
			}), ...params);
		});
	}
}
```

æ³¨ï¼šé«˜é˜¶å‡½æ•°è¯´çš„ç®€å•ç‚¹å°±æ˜¯ä¼ å…¥ä¸€ä¸ªå‡½æ•°å¹¶è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œåˆ‡è®°è¿”å›çš„æ˜¯å‡½æ•°è¿˜æ²¡æœ‰æ‰§è¡Œï¼Œé‡åˆ°äº†å¤šå°‘å†™é˜²æŠ–èŠ‚æµçš„å°ä¼™ä¼´æ˜¯å¿˜äº†æ‰§è¡Œè¿˜å„ä¸ªç¾¤é‡Œé—® why çš„~

## å‘æŒ¥TypeScriptç±»å‹çš„å¼ºå¤§ä¹‹å¤„ï¼š

### Typescriptå†…ç½®ç±»å‹å·¥å…·ï¼š

1.  `Parameters<T>`ï¼šæå–å‡½æ•°ç±»å‹çš„å‚æ•°æ‰€ç»„æˆçš„ç±»å‹åˆ—è¡¨ï¼›
1.  `NonNullable<T>`ï¼šæå–ä¼ å…¥ç±»å‹é™¤ nullã€undefined ä»¥å¤–çš„ç±»å‹ï¼›

### ç±»å‹ç¼–ç¨‹åˆ†æï¼š

1.  promisify å‡½æ•°çš„è¾“å…¥ç±»å‹çº¦æŸï¼šè¾“å…¥çš„å†…å®¹å‡æ˜¯uniapp apiï¼ˆå‡½æ•°ï¼‰ï¼Œæ‰€ä»¥ä½¿ç”¨æ³›å‹æ¥çº¦æŸè¾“å…¥çš„ç±»å‹ï¼›

```JavaScript
const promisify = <P extends (...args: any) => any>(api: P) => {}
```

2.  promisify è¿”å›çš„å‡½æ•°çš„è¾“å…¥ç±»å‹çº¦æŸï¼šè¿™ä¸ªè¾“å…¥ç±»å‹å®é™…æ˜¯ uniapp api æ‰§è¡Œçš„çš„å½¢å‚ç±»å‹ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨å†…ç½®çš„ç±»å‹å·¥å…·ï¼ˆ1ï¼‰æ¥æå–ï¼Œæˆ‘ä»¬åªæå–ç±»å‹åˆ—è¡¨çš„ç¬¬ä¸€é¡¹å³å¯ï¼Œæœ‰å®é™…éœ€è¦å¯ä»¥å†æ‰©å±•ï¼š

```JavaScript
type ParameterFirst<T extends (...args: any) => any> = Parameters<T>[0];

export const promisify = <P extends (...args: any) => any>(api: P) => {
    return (options: ParameterFirst<P>) => {}
}
```

3.  æ‰§è¡Œå®Œ promisify è¿”å›çš„å‡½æ•°å Promise å¯¹è±¡çš„ç±»å‹çº¦æŸï¼šè¿™é‡Œåªèƒ½é€šè¿‡æ³›å‹çº¦æŸæˆåŠŸçŠ¶æ€çš„ç±»å‹ï¼ŒæˆåŠŸçŠ¶æ€çš„ç±»å‹å®é™…ä¸Šæ˜¯ uniapp api é€‰é¡¹ä¸­ success å±æ€§ï¼ˆå›è°ƒå‡½æ•°ï¼‰è¿”å›çš„ç±»å‹ã€‚æˆ‘ä»¬éœ€è¦å…ˆæå–åˆ° success å±æ€§ï¼Œç„¶åå†æ¬¡ä½¿ç”¨å†…ç½®ç±»å‹å·¥å…·ï¼ˆ1ï¼‰æ¥æå–å›è°ƒå‡½æ•°çš„è¿”å›ç±»å‹ã€‚

```JavaScript
type ParameterSuccess<T extends (...args: any) => any> = ParameterFirst<NonNullable<Parameters<T>[0]['success']>>;
```

æ³¨ï¼šå› ä¸º`Parameters<T>`å­˜åœ¨å¯èƒ½å¾—åˆ°ä¸€ä¸ª undefined ç±»å‹çš„æƒ…å†µï¼Œæ‰€ä»¥ä½¿ç”¨ `NonNullable<T>` æ¥è¿›è¡ŒåŒ…è£…ã€‚

## å®Œæ•´çš„promisifyå·¥å…·ç±»ï¼š

```JavaScript
/**
 *  uni.request({
 *      url: 'https://jsonplaceholder.typicode.com/todos/1',
 *      success: (res) => {
 *          console.log(res.data);
 *      }
 *  });
 *  
 *   promisify(uni.request)({ url: '' }).then(res => {
 *     // res.data
 *   }).catch(err => {
 *
 *   });
 *  
 * @param api 
 * @returns 
 */

/**
 * æå–ä¼ å…¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå½¢å‚å‚æ•°çš„ç±»å‹
 */
type ParameterFirst<T extends (...args: any) => any> = Parameters<T>[0];
/**
 * æå–ä¼ å…¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå½¢å‚å‚æ•°ä¸­keyä¸ºsuccessçš„å‚æ•°çš„ç±»å‹ï¼›
 * å› successç±»å‹ä¸ºå‡½æ•°ç±»å‹ï¼Œæ‰€ä»¥å†æ¬¡æå–successå‡½æ•°çš„ç¬¬ä¸€ä¸ªå½¢å‚å‚æ•°çš„ç±»å‹
 */
type ParameterSuccess<T extends (...args: any) => any> = ParameterFirst<NonNullable<Parameters<T>[0]['success']>>;

export const promisify = <P extends (...args: any) => any>(api: P) => {
    return (options: ParameterFirst<P>) => {
        return new Promise<ParameterSuccess<P>>((resolve, reject) => {
            api(
                Object.assign({}, options, {
                    success: resolve,
                    fail: reject,
                }),
            );
        });
    };
};
```

## ç»“è¯­ï¼š

æ—¢ç„¶é€‰æ‹© TypeScript æ¥ç¼–å†™é¡¹ç›®ï¼Œå°±è¦å°½å¯èƒ½çš„å‘æŒ¥å‡º TypeScript ä½œç”¨ï¼Œåœ¨ä¸‡èˆ¬æ— å¥ˆçš„æ—¶å€™å†ç”¨ any ä¹Ÿä¸è¿Ÿ ~~~